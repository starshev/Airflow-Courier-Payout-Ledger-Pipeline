### Содержимое репозитария проекта

readme.md - описание проекта \
«Разработка DWH».md - проектирование ETL \
Documentation.pdf - схема ETL \
папка «sql» - скрипты SQL \
папка «modules» - модули Python \
папка «dags» - пайплайн

### Новый источник данных - API курьерской службы

#### 1. Метод "GET / couriers"

Применяется сортировка по имени курьера, по возрастанию. \
Порция записей в запросе: 50

Ответ = массив JSON с полями:

* "_id" - id курьера (строка)
* "name" - Ф.И.О. курьера (строка)

#### 2. Метод "GET / deliveries"

Применяется сортировка по дате доставки, по возрастанию.\
Порция записей в запросе: 50

Ответ = массив JSON с полями:

* "order_id" - id заказа (строка)
* "order_ts" - timestamp заказа
* "delivery_id" - id доставки (строка)
* "courier_id" - id курьера (строка)
* "address" - адрес доставки (строка)
* "delivery_ts" - timestamp факта доставки
* "rate" - рейтинг доставки (целое число 1-5)
* "sum" - сумма заказа (большое число с десятичными знаками)
* "tip_sum" - сумма чаевых (большое число с десятичными знаками)

##### Примечания

* В респонсе метода "GET / couriers" отсутствует инкрементальный суррогатный ключ и дата обновления сущности, что исключает поддержку SCD2 и возможность инкрементальной загрузки. Данное измерение будет полностью перезаписываться по актуальному состоянию в каждом прогоне дага, с обновлением единственного атрибута (Ф.И.О.) по SCD1.

### Реализация модулей Python по инкрементальной загрузке из источника в STG

* */modules/load_couriers.py* - загружает данные по курьерам
* */modules/load_deliveries.py* - загружает данные по доставкам

### Проектирование ETL

#### 1. **CDM**

Витрина **cdm.dm_courier_ledger** согласно требованиям. \
Типы данных согласно исследованиям источника и уже имеющимся данным в DWH. \
\
Ограничения:
- суррогатный pk с авто-инкрементом
- для денежных и количественных значений >=0 и дефолт 0
- на все поля not null
- рейтинг от 0 до 5 включительно
- месяц от 1 до 12 включительно
- год от 2022 до 2100 включительно
- UNIQUE на комбинацию: бизнес-ключ курьера + год отчета + месяц отчета

Реализация витрины: */sql/DDL_cdm.dm_courier_ledger.sql* \
Реализация SQL-скрипта обновления витрины: */sql/courier_ledger_update.sql*

#### 2. **DDS**

Модель «снежинка».

Факты:
* **dds.fct_deliveries** (доставки, сделанные курьерами)

Измерения:
* курьеры **dds.dm_couriers** (новое)
* заказы **dds.dm_orders** (уже есть в DWH, делим это измерение с соседней «снежинкой», ничем не дополняем)
* временные метки **dds.dm_timestamps** (также уже есть в DWH, дополняем его свежими датами доставок)

Типы данных - согласно дальнейшему применению для построения витрины **cdm.dm_courier_ledger**. \
\
Атрибуты в таблице измерения (курьеры):
- бизнес-ключ курьера
- Ф.И.О. курьера

Измерения в таблице фактов: 
- timestamp доставки
- id заказа
- сумма заказа
- id курьера

Показатели в таблице фактов: 
- рейтинг доставки
- сумма чаевых

Технические атрибуты в таблице фактов:
- бизнес-ключ доставки

Ограничения:
- во всех таблицах суррогатные pk с авто-инкрементом
- для денежных и количественных значений: >= 0
- на все поля not null
- FK в таблице фактов (доставок) на суррогатные ключи курьера, заказа и timestamp
- UNIQUE на бизнес-ключ курьера (для защиты от дублей) в таблице курьеров - здесь актуально, поскольку SCD1
- UNIQUE на бизнес-ключ доставки (защита от дублей) в таблице фактов - здесь актуально, поскольку SCD0

Реализация таблицы фактов: */sql/DDL_dds.fct_deliveries.sql* \
Реализация таблицы измерений (курьеры): */sql/DDL_dds.dm_couriers.sql* \

Реализация SQL-скрипта инкрементальной загрузки доставок: */sql/deliveries_stg_to_dds.sql* \
Реализация SQL-скрипта инкрементальной загрузки курьеров: */sql/couriers_stg_to_dds.sql* \
Реализация SQL-скрипта инкрементальной загрузки таймстемпов: */sql/timestamps_stg_to_dds.sql* \

##### Примечания

Инкрементальная загрузка как фактов, так и измерений (курьеры, таймстемпы) обеспечивается через запись последней обработанной даты доставки (из таблицы **stg.deliverysystem_deliveries**) в таблицу **dds.srv_wf_settings** с рабочим ключом «deliveries_stg_to_dds_workflow».

Загрузка в измерение «курьеры» происходит по SCD1 = запись новых / перезапись атрибутов существующих при конфликте бизнес-ключа,
в измерение «таймстемпы» - по SCD0 = запись новых / ничего не делаем при конфликте UNIQUE-ключа «ts»,
в таблицу фактов - по SCD0 = запись новых / ничего не делаем при конфликте бизнес-ключа.

#### 3. **STG**

Таблица **stg.deliverysystem_couriers** для инкрементальных загрузок по API с методом "GET / couriers" из системы доставки:
- суррогатный pk с авто-инкрементом
- JSON-ответ целиком как текст
- бизнес-ключ курьера, выделенный из JSON-ответа

Ограничения:
- UNIQUE на бизнес-ключ курьера (для защиты от дублей)

Полная выгрузка всех курьеров в каждом прогоне, вставка в STG новых курьеров / обновление существующих по SCD1.

Таблица **stg.deliverysystem_deliveries** для инкрементальных загрузок по API с методом "GET / deliveries" из системы доставки:
- суррогатный pk с авто-инкрементом
- JSON-ответ целиком как текст
- бизнес-ключ доставки, выделенный из JSON-ответа
- timestamp доставки, выделенный из JSON-ответа

Ограничения:
- UNIQUE на бизнес-ключ доставки (для защиты от дублей)

Реализация: */sql/DDL_stg.deliverysystem_deliveries.sql*

Инкрементальная загрузка обеспечивается через запись последней обработанной даты доставки в таблицу **stg.srv_wf_settings** с рабочим ключом «deliverysystem_origin_to_stg_workflow».

### Общие примечания

Рейтинг доставки по умолчанию установлен как 0. В витрине при расчете среднего рейтинга учитываем только рейтинги больше 0 (т.е. отсеивая доставки, по которым рейтинг мог быть не оставлен).

Все движения между слоями реализовал через PostgresOperator, поскольку все слои находятся в бд Postgres.

Пайплайн настроен на ежедневный пробег. Так можно видеть текущее состояние по выплатам в т.ч. на текущий момент по текущему месяцу с задержкой максимум в сутки.
Запуск запланирован на 00:15, поскольку другие даги по наполнению DWH работают каждые 15 минут, так гарантируется полнота собранного отчета за прошедшие сутки.
Опционально, можно добавить сенсор для ожидания выполнения других дагов по наполнению DWH.

Согласно требованиям, в первом прогоне загрузка данных происходит за последние 7 дней - первая выгрузка ставит last_loaded_ts в сервисной таблице на минус 7 дней от даты прогона дага.

Пока нет вводных вводных по таймзоне, даг не проходил калибровку между таймзонами API и Airflow, таким образом, в тестовом режиме возможен приход данных немного за пределами «from» и «to».